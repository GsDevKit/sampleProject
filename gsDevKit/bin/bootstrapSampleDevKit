#! /bin/bash -x
#=========================================================================
# Copyright (c) 2015 GemTalk Systems, LLC <dhenrich@gemtalksystems.com>.
#=========================================================================

usage() {
  cat <<HELP
USAGE: $(basename $0) [-h] <sample-project-git-root>
Bootstrap the Sample project. Clone the set of GitHub projects used by the
Sample project. Set up the tODe and GsDevKitHome infrastructure for the
Sample project in $GS_HOME based on the templates in <sample-project-git-root>.

This script should be run once to do the initial cloning of github 
repositories and to set up the sample project directory structure in 
$GS_HOME.

OPTIONS
  -h show usage

EXAMPLES
  $(basename $0) -h
  $(basename $0) $SAMPLE_HOME

HELP
}

set -e # exit on error
if [ "${GS_HOME}x" = "x" ] ; then
  echo "the GS_HOME environment variable needs to be defined"; exit 1
fi
source ${GS_HOME}/bin/shFunctions

if [ $# -ne 1 ]; then
  usage; exit 1
fi
sampleHOME=$1
sampleGitRoot=${sampleHOME}/gsDevKit/git

getOpts_help $@ #parse standard (-h) options

# clone git repositories
pushd $sampleGitRoot
if [ ! -d glass ]; then
  git clone git@github.com:glassdb/glass.git
fi
if [ ! -d Grease ]; then
  git clone git@github.com:GsDevKit/Grease.git
fi
if [ ! -d metacello-work ]; then
  git clone git@github.com:dalehenrich/metacello-work.git
fi
if [ ! -d Seaside31 ]; then
  git clone git@github.com:GsDevKit/Seaside31.git
fi
if [ ! -d tode ]; then
  git clone --branch dev git@github.com:dalehenrich/tode.git
fi
if [ ! -d zinc ]; then
  git clone git@github.com:GsDevKit/zinc.git
fi
popd

# Setting things up to bootstrap GemStone and Pharo from local git clones
#   Copy server script templates to $GS_HOME/sys/local/server/scripts, replacing ${gitRoot} with ${sampleGitRoot}
for filename in  ${sampleHOME}/gsDevKit/tode/sys/local/server/scripts/* ; do
  cat $filename | sed s_\$\{gitRoot\}_${sampleGitRoot}_ > $GS_HOME/tode/sys/local/server/scripts/$(basename "$filename")
done

# Copy the sample project project entry to $GS_HOME/tode/sys/local/projects, replacing ${gitRoot} with ${sampleHOME}
filename=sample.ston
cat ${sampleHOME}/gsDevKit/${filename} | sed s_\$\{sampleHome\}_${sampleHOME}_ > $GS_HOME/tode/sys/local/projects/${filename}

#   Copy project entry templates to $GS_HOME/tode/sys/local/projects, replacing ${gitRoot} with ${sampleGitRoot}
for filename in  ${sampleHOME}/gsDevKit/tode/sys/local/projects/* ; do
  cat $filename | sed s_\$\{gitRoot\}_${sampleGitRoot}_ > $GS_HOME/tode/sys/local/projects/$(basename "$filename")
done

#   Copy pharo bootstrap templates to  $GS_HOME/tode/sys/local/pharo, replacing ${gitRoot} with ${sampleGitRoot}
for filename in  ${sampleHOME}/gsDevKit/tode/sys/local/pharo/* ; do
  cat $filename | sed s_\$\{gitRoot\}_${sampleGitRoot}_ > $GS_HOME/tode/sys/local/pharo/$(basename "$filename")
done
